# Foodel Server

## General 

The role of the server project is to provide access to the FoodelSolver via a web interface.

The core of the server is based on JLHTTP. It would be possible to use a more "heavy weight" server such as Tomcat, but the design philosopy of Foodel is to keep the software (and the install) as simple as possible.

`edu.napier.foodel.server` contains those classes that manage the  Server and Tasks (see below). 'edu.napier.foodel.serber.handlers' contain those classes that handle HTTP requests.

The sever is based on the concept of Task objects - each task encompasses a Foodel problem that is to be solved, the server maintains a list of Tasks based on those problems that have been uploaded. The `main'` method of `Server`is used to launch the server process and `Server.processloop` contains the loop that manages the queue of Tasks, passing them to 'edu.napier.foodel.facade.FoodelSolver' for solving.

Unless you have used the server.properties 'savesolutions' option to True then all of the problems and data uploaded to the server is lost when the server is stopped. 

## Valid URLS 

Note that you should substitute your host name for <host>, for most installations localhost will suffice. If you are using a port other than 80 (e.g. the default 8080) then you must specify the port as well. For example an installation using the default properties would respond the following URL:

`http://localhost:8080/status/`

The classes in `edu.napier.foodel.server.handlers` provide the HTTP service as follows:

* `Default` serves the home page when any unrecognised URL is requested

* `ServerStatus`  myHost/status 

provides a page that confirms the server is running. It also provides a list of tasks loaded on the server and a link to them.

* 'UploadProblem' myHost/new

Presents the user with a simple drag/drop form that allows a CSV problem file to be uploaded to myHost/upload

myHost/upload 

Processes the form containing the problem data (from /new ) . If the file sent does not contain CSV data an error page is displayed. Otherwise a confirmation page is shown which contains the alphanumeric key required to retrieve the problem if server.properties contains `nokey=false`

If the upload is successful this page redirects the to myhost/job

* `TaskHandler` myHost/job?key=<key>&id=<ref> 

Where key is the unique alphanumeric task key given to the user when they upload and ref is the problem reference specified by the user. If the server.properties file contains `nokey=True` then the key paramater is not required NOTE: do not set `nokey` to True in a shared environment otherwise anyone will be able to see your problem/solution.  
If the task is queued to be solver (or being solved) a 'please wait' page will be displayed, once the task has been solved an page containining an HTML summary of the solution will be returned.

* `GPXHandler` myhost/gpx?key=<key>&run=<run>

Returns a GPX file representing the route to be taken for the problem matching <key> route <route> (Only works if the problem has been solved).

* `MapHandler` myhost/map?key=<key>&run=<run>

Returns an HTML page containing a map representing the route to be taken for the problem matching <key> route <route> (Only works if the problem has been solved).

* The folder /public_html/ can contain static files that can be acessed via the <myhost>/static/ . This uswful for storing .CSS, javascript, images etc, you can also place your own HTML files here, but it is not recommended that you use this facility as a general webserver.

## Config files

The FoodelServer cotains a number of config files which may be used to customise your installation of foodel. Editing these files (with care!) will allow you to heavily customise foodel and potentally integrate it into other systems.  

HTML files:

The first set of files are used to hold HTML code that is added to the pages generated by the server (not those from public_html). The look/feel of the Foodel interface can be altered by changing their contents. 

* `/config/body.html` contains HTML code that will be added after the <body> tag of html returned from the server.
* `/config/footer.html` contains HTML code that will be added before the <\body> tag of html returned from the server.
* `/config/header.html` contains HTML code that will be added added ot the the header of any HTML code returned by the server

Configuration File:

* `/config/server.properties` allows access to the server configuaration. Comments in the file explain the purpose of the entries. PLEASE EDIT THIS FILE WITH CARE! 
  *   A mistake made in editing may cause your Foodel installtion to crash.
  *   Some items such as `nokeys=true` have security implications.
  *  Please ask for advice before editing this file!
 

Data files

* `/data/osm/` contains open streetmap data for Foodel use. The default data covers the City of Edinburgh for other areas, please place the appropriate .PBF file in `/data/`  and delete the files currently there. Please note that there will be a long delay when starting up for the first time when inporting new OSM data - don't worry this is normal.

Logs
* `/logs/` will contain a number of .log files. These contain a brief record of how Foodel has been used and in particular any errors or problems. Please note that they do not contain any problem or solution data. The log files can be useful when trying to find the cause of a problem. If you are having difficulties, sending us your log files  is one way that can allow us to help.

public_html

This directory contains files that foodel server will make available over HTTP. 

DO NOT PLACE ANY FILES IN THIS DIRECTORY WHICH ARE CONFIDENTIAL - if you are using a shared Foodel installation then the contents of this directory are visible to everyone!

`/public_html/dragdrop.js`  Javascript code use to implement the drag and drop upload

`public_html/foodel.css` The CSS file used to format the HTML returned by the server. Edit with care and thought.

`sols` If you have the option to save solutions on the server `savesolutions=True`  then the your Foodel problems will be saved here as JSON. This option is set to false by default. If it is enabled it will alllow access to previously solved problems, but be aware of data protection issues if you are processing sensitive data and/or you are sharing Foodel.